# 2023년 4월 13일 TIL

# 메모리구조

`4월 13일`

프로그램이 실행되면

운영체제(OS)는 메모리(RAM)에 이 프로그램을 위한 공간을 할당한다.

그 공간은

- Code
- Data
- Heap
- Stack

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/d091fa1e-c409-4bd0-8e13-a8dee395b177/Untitled.png)

## 코드영역

작성한 소스코드가 기계어 형태로 저장된다.

컴파일 타임에 결정되고, 중간에 코드가 변경되지 않도록 Read-Only 형태로 저장된다.

기계어 : 컴퓨터가 읽을 수 있는 비트단위로 이루어진 언어

## 데이터 영역

전역변수, Static 변수가 저장된다.

프로그램 시작과 동시에 할당되고, 

프로그램이 종료되어야 메모리가 해제된다.

실행도중 변수 값이 변경될 수 있으니 Read-Write로 지정됨.

```swift
struct Korean {
    static let country = "Korea" //스태틱 변수로 데이터 영역에 할당
}

var name: String? //전역 변수로 데이터 영역에 할당
var age: Int? //전역 변수로 데이터 영역에 할당

func fetchData() {

}
```

static 경우에 기본동작이 lazy이기 때문에 해당 값에 처음 접근할 때 값이 할당되어 메모리에 올라감.

## 힙 영역

*프로그래머가 할당/해제하는 메모리 영역*

*프로그래머는 malloc, calloc으로 힙에 메모리를 할당할 수 있으며, 이를 ‘동적 할당’이라고 함.*

*사용하고 난 후에는 반드시 메모리 해제를 해줘야 한다.*

*그렇지 않으면 memory leak이 발생함*

*Code, Data, Stack 중 유일하게 런타임 시에 결정되기 때문에*

*데이터 크기가 확실하지 않을 때 사용한다.*

Swift에서는 항상 힙에 할당하고 있다. 언제냐면

클래스 인스턴스, 클로저 같은 참조 타입의 값들은 모두 힙에 자동할당이 된다.

그리고 힙의 특징으로 힙을 사용하면 반드시 “메모리 해제”를 해줘야 한다.

Swift에서는 ARC를 통해 힙에 할당된 메모리가 더 이상 쓸모 없어지면(참조되지 않으면) 자동으로 해제해주기 때문이다.

힙의 장점🅾️

- 메모리 크기에 대한 제한이 없다.
- 본질적인 범위가 전역이기 때문에, 프로그램의 모든 함수에서 액세스 할 수 있다.

힙의 단점❌

- 할당작업, 해제 작업으로 인한 속도 저하
- 힙 손상(이중 해제, 해제 후 사용 등) 작업으로 인한 속도 저하
- 힙 경함(두 개 이상 쓰레드가 동시에 접근하려 할 때 Lock이 걸린다)으로 인한 속도 저하
- 메모리를 직접 관리 해야함 (해제 안해주면 메모리 누수발생)

단점 : 속도저하와 메모리 누수 

## 스택 영역

함수 호출 시 함수의 지역변수, 매개변수, 리턴 값 등등이 저장되고, 함수가 종료되면 저장된 메모리도 해제된다.

컴파일타임에 결정되기 때문에 무한히 할당할 수 없다.

스택은 프로그램이 자동으로 사용하는 임시 메모리 영역이다.

함수를 호출하게 되면

```swift
func add(_ a: Int, _ b: Int) -> Int { // 파라미터 a, b는 스택에 할당
    let result = a + b               // 지역변수 result는 스택에 할당
    return result
}
```

OS는 내부적으로 함수 안에 선언된 파라미터, 지역변수 등을 스택에 할당한다.

그리고 함수가 종료되는 시점에 스택에 저장된 메모리는 알아서 반환된다.

또한 스택은 “LIFO”(Last in, First out)데이터 구조이다.

(먼저 생성된 변수가 가장 나중에 해제 된다.)

CPU에 의해 관리되고 최적화 돼서 속도가 매우 빠르다.

스택의 장점

- CPU가 스택 메모리를 효율적으로 구성하기 때문에 속도가 매우 빠르다.
- 메모리를 직접 해제를 해주지 않아도 된다.

스택의 단점

- 메모리 크기에 대한 제한이 있다.
- 지역변수만 엑세스가 가능하다.

## 힙 / 스택의 비교

스택은 메모리가 한정되어 있기 때문에 너무 큰 메모리는 할당할 수 없다.

→ 데이터의 크기를 모르거나, 

스택에 저장하기엔 큰 데이터의 경우엔 힙에 할당하고

그 외에는 스택에 할당하면 된다.

(인스턴스, 클로저 등 자동으로 힙에 할당되는 것 외에 직접 할당하는 경우에 ‼️)

혹여나 스택에 많은 메모리가 할당이 되면

→ 스택 오버 플로우가 발생함.

### 스택 오버 플로우

스택에 너무 많은 메모리가 할당하게 되어 자신의 스택 영역을 초과한 경우.

iOS의 경우 

스택 오버 플로우가 발생 시 어플이 죽어버린다.

(예시 : 무한 재귀)

힙과 스택은 같은 메모리 영역을 공유한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/36dd7d3d-05d6-408f-b11e-64795c0bf684/Untitled.png)

같은 메모리 공간이지만

힙 영역은 낮은 메모리 주소부터 할당받고,

스택 영역은 높은 메모리 주소부터 할당받음

따라서 힙 또한 자신의 영역 외로 확장하려다 보면은,

힙 오버 플로우가 발생한다.

# Reference

[https://babbab2.tistory.com/25](https://babbab2.tistory.com/25)
